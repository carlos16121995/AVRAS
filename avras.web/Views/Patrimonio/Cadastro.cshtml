
@{
    ViewData["Title"] = "Cadastro";
    Layout = "~/Views/Shared/_Layout_Painel.cshtml";
}


@section script{
    <script>
        $(document).ready(
            $("#carregando").html('<i class="fas fa-spinner fa-spin">'),
            carregarSelect(),

        );
        window.onload = function () {
            inicio();
        };
        function carregarSelect() {
            $("#carregando").html('<i class="fas fa-spinner fa-spin">');
            $.ajax({
                type: 'GET',
                url: '/Patrimonio/BuscarTipos',
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data.cargo != null) {
                        $("#tipo").html("<option value='0'>--Selecione um Tipo--</option>");
                        sel = document.getElementById("tipo");

                        for (var i = 0; i < data.cargo.length; i++) {
                            var option = document.createElement("option");
                            option.value = data.cargo[i].id;
                            option.text = data.cargo[i].nome;
                            sel.appendChild(option);
                        }
                    }
                    $("#carregando").html('');
                },
                error: function (error) {
                     $('#Erro').modal('show');
                    $('#titulo').html("Ops... Ocorreu um erro!");
                    $('#corpo').html("Tente novamente.");
                    $("#carregando").html('');
                }
            });
        }
        function inicio() {
            var id = $("#id").val();
            if (id != "") {
                $.ajax({
                    type: 'GET',
                    url: '/Patrimonio/BuscarPatrimonioPorId',
                    data: {Id: id,},
                    success: function (data) {
                        if (data != null) {
                            $("#id").val(data.id);
                            $("#nome").val(data.nome);
                            $("#descricao").val(data.descicao);
                            $("#anotacao").val(data.anotacao);
                            $("#compra").val((data.valorCompra).toLocaleString('pt-BR'));
                            $("#perda").val((data.valorPerda).toLocaleString('pt-BR'));
                            $("#quantidade").val(data.quantidade);
                            $("#minimo").val(data.quantidadeMinima);
                            date = FormatarDataPadraoParaIngles(data.dataPerda);
                            $("#data_perda").val(date);
                            date = FormatarDataPadraoParaIngles(data.dataAquisicao);
                            $("#data_aquisicao").val(date);
                            $(".tipo option[value='" + data.tipoPatrimonioId + "']").attr('selected', 'selected');
                            if (data.disponibilidade == 0) {
                                $("#disponibilidade").prop("checked", false);
                            }
                            else {
                                $("#disponibilidade").prop("checked", true);
                            }
                             $(".permissao option[value='" + data.tipoPatrimonioId + "']").attr('selected', 'selected');
                    
                        }
                        $("#carregando").html('');
                    },
                    error: function (data) {
                        $('#Erro').modal('show');
                        $('#titulo').html("Ops... Ocorreu um erro!");
                        $('#corpo').html("Tente novamente.");
                        $("#carregando").html('');
                    }
                });
            }
        }
      
        function validaNome() {
            var nome = $("#nome").val();
            if ((nome != "") && (nome.length > 3)) {
                $("#nome").focus();
                $("#nome").addClass("is-valid");
                if ($("#nome").hasClass("is-invalid"))
                    $("#nome").removeClass("is-invalid");
                return true;
            }
            else {
                $("#nome").focus();
                $("#nome").addClass("is-invalid");
                if ($("#nome").hasClass("is-valid"))
                    $("#nome").removeClass("is-valid");

                return false;
            }
        }
        function formatarMoeda(elemento) {
            var valor = elemento.value;

            valor = valor + '';
            valor = parseInt(valor.replace(/[\D]+/g, ''));
            valor = valor + '';
            valor = valor.replace(/([0-9]{2})$/g, ",$1");

            if (valor.length > 6) {
                valor = valor.replace(/([0-9]{3}),([0-9]{2}$)/g, ".$1,$2");
            }
            elemento.value = valor;
            if (valor == "NaN" || valor == 0) {
                $("#valor").focus();
                $("#valor").addClass("is-invalid");
                if ($("#valor").hasClass("is-valid"))
                    $("#valor").removeClass("is-valid");
                return false;
            }
            else {
                $("#valor").focus();
                $("#valor").addClass("is-valid");
                if ($("#valor").hasClass("is-invalid"))
                    $("#valor").removeClass("is-invalid");
                return true;
            }
        }
        function somenteNumeros(num) {
            var er = /[^0-9.]/;
            er.lastIndex = 0;
            var campo = num;
            if (er.test(campo.value)) {
                campo.value = "";
            }
            if (num.value == "") {
                $("#quantidade").focus();
                $("#quantidade").addClass("is-invalid");
                if ($("#quantidade").hasClass("is-valid"))
                    $("#quantidade").removeClass("is-valid");
                return false;
            }
            if (num.value == 0) {
                $("#quantidade").focus();
                $("#quantidade").addClass("is-invalid");
                if ($("#quantidade").hasClass("is-valid"))
                    $("#quantidade").removeClass("is-valid");
                return false;
            }
            if (isNaN(num.value)) {
                $("#quantidade").focus();
                $("#quantidade").addClass("is-invalid");
                if ($("#quantidade").hasClass("is-valid"))
                    $("#quantidade").removeClass("is-valid");
                return false;
            }
            else {
                $("#quantidade").focus();
                $("#quantidade").addClass("is-valid");
                if ($("#quantidade").hasClass("is-invalid"))
                    $("#quantidade").removeClass("is-invalid");
                return true;
            }
        }
        function Limpar() {
            $("#id").val("0");
            $("#nome").val("");
            $("#descricao").val("");
            $("#compra").val("");
            $("#venda").val("");
            $("#anotacao").val("");
            $("#dataAquisicao").val("");
            $("#dataPerda").val("");
            if ($("#tipo option").has('selected')) {
                 $("#tipo option").removeAttr('selected');
            }
            $(".permissao option[value='" + 0 + "']").attr('selected', 'selected');
            var txt = '<button class="btn btn-dark float-right my-3 " onclick="javascript: Gravar();" type="button">Gravar</button>';
            $("#gravar").html(txt);
            $("#divResultado").html("");
            $("#excluir").html("");

            $("#id").val("");
            $("#id").removeClass("is-invalid");
            $("#id").removeClass("is-valid");

            $("#nome").val("");
            $("#nome").removeClass("is-invalid");
            $("#nome").removeClass("is-valid");

            $("#quantidade").val("");
            $("#quantidade").removeClass("is-invalid");
            $("#quantidade").removeClass("is-valid");

            $("#minimo").val("");
            $("#minimo").removeClass("is-invalid");
            $("#minimo").removeClass("is-valid");

            $("#compra").val("");
            $("#compra").removeClass("is-invalid");
            $("#compra").removeClass("is-valid");

            $("#venda").val("");
            $("#venda").removeClass("is-invalid");
            $("#venda").removeClass("is-valid");
        }
        function FormatarDataPadraoParaIngles(date) {
            var data = date.split("-");
            var ano = data[0];
            var mes = data[1];
            var dia = data[2];
            dia = dia.slice(0, 2);
            date = ano + "-" + mes + "-" + dia;

            return date;
        }
        function FormatarDataInglesParaPadrao(date) {
            var data = date.split("-");
            var dia = data[0];
            var mes = data[1];
            var ano = data[2];

            date = dia + "/" + mes + "/" + ano;

            return date;
        }
        function Gravar() {
            var valida = true;
            if (validaNome() == false) {
                valida = false;
            }
            var compra = $("#compra");
            if (formatarMoeda(compra[0]) == false) {
                valida = false;
            }
            var perda = $("#perda");
            if (formatarMoeda(perda[0]) == false) {
                valida = false;
            }
            var quantidade = $("#quantidade");
            if (somenteNumeros(quantidade[0]) == false) {
                valida = false;
            }
            
            if (valida == true) {
                var disponivel = 0;
                if ($("#disponibilidade").is(':checked')) {
                    disponivel = 1;
                }
                var id = $("#id").val();
                if (id == "") {
                    id = 0;
                }
                var form = {
                    Id: id,
                    Nome: $("#nome").val(),
                    Descicao: $("#descricao").val(),
                    Quantidade: $("#quantidade").val(),
                    ValorCompra: $("#compra").val(),
                    ValorPerda: $("#perda").val(),
                    Anotacao: $("#anotacao").val(),
                    DataAquisicao: $("#data_aquisicao").val(),
                    DataPerda: $("#data_perda").val(),
                    CategoriaId: $("#tipo :selected").val(),
                    disponibilidade: disponivel,
                };

                $.ajax({
                    type: 'POST',
                    url: '/Patrimonio/Gravar',
                    data: form,
                    success: function (response) {
                        if (response.retorno == 1) {


                            window.location.href = "/Patrimonio/Listar_Patrimonio";
                        }
                        
                        else {
                            $('#Erro').modal('show');
                            $('#titulo').html("Ops...");
                            $('#corpo').html("Parece que houve um problema com algum campo preenchido. Verifique se os dados foram preenchidos corretamente.");


                        }
                    },
                    error: function (error) {
                        $('#Erro').modal('show');
                        $('#titulo').html("Ops... Ocorreu um erro!");
                        $('#corpo').html("Tente novamente.");
                    }
                });
            }
            else {
                $('#Erro').modal('show');
                $('#titulo').html("Formulário incompleto");
                $('#corpo').html("Preencha todos os campos corretamente.");
            }

        }
    </script>
}

<div class="container my-5 ">
    <div class="row ">
        <div class="col-lg-1 col-12" align="center">
            <span> <img src="~/images/patrimonio.png" class="logo" alt="Imagem de 1 maquina de cortar grama" /></span>
        </div>
        <div class="col-lg-6 col-12 align-self-center float-none">
            <h2> Cadastro de Patrimonio </h2><span id="carregando"></span>
        </div>
    </div>

</div>
<div class="container d-block">
  


        <input type="hidden" id="id" value="@ViewData["Id"]" />
        <div class="row">
            <div class="form-group col-12">
                <label for="nome">Nome:</label>
                <input type="text" class="form-control" id="nome" onchange="validaNome();" value="@ViewData["Nome"]" required>
                <div class="valid-feedback" id="valida-nome-valid">
                </div>
                <div class="invalid-feedback" id="valida-nome">
                    Nome inválido!
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-12">
                <label for="nome">Tipo:</label>
                <select class="tipo form-control" id="tipo"></select>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-12 col-lg-6">
                <label for="quantidade">Quantidade:</label>
                <input type="text" class="form-control" pattern="(\b[0-9]\b)/g" onkeyup="somenteNumeros(this);" id="quantidade" value="@ViewData["Quantidade"]" required>
                <div class="valid-feedback" id="valida-quantidade-valid">
                </div>
                <div class="invalid-feedback" id="valida-quantidade">
                    Quantidade inválida!
                </div>
            </div>
            <div class="form-group col-12 col-lg-6">
                <label for="descricao">Descrição</label>
                <input type="text" class="form-control" name="descricao" id="descricao" >
                <div class="valid-feedback" id="valida-descricao-valid">
                </div>
                <div class="invalid-feedback" id="valida-descricao">
                    Descricao inválida!
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-12 col-lg-6">
                <label for="compra">Valor de compra:</label>
                <input type="text" pattern="(\b[0-9]\b)/g" onkeyup="formatarMoeda(this);" class="form-control" id="compra" value="@ViewData["Compra"]" required>
                <div class="valid-feedback" id="valida-compra-valid">
                </div>
                <div class="invalid-feedback" id="valida-compra">
                    Valor inválido!
                </div>
            </div>
            <div class="form-group col-12 col-lg-6">
                <label for="venda">Valor de perda:</label>
                <input type="text" pattern="(\b[0-9]\b)/g" onkeyup="formatarMoeda(this);" class="form-control" id="perda"  required>
                <div class="valid-feedback" id="valida-perda-valid">
                </div>
                <div class="invalid-feedback" id="valida-perda">
                    Valor perda inválido!
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group form-check col-6">
                <label for="disponibilidade">Disponível?</label>
                <input type="checkbox" class="form-check-input" value="1" id="disponibilidade">
            </div>
            <div class="form-group col-12 col-lg-6">
                <label for="anotacao">Anotação</label>
                <input type="text" class="form-control" name="anotacao" id="anotacao">
                <div class="valid-feedback" id="valida-anotacao-valid">
                </div>
                <div class="invalid-feedback" id="valida-anotacao">
                    Descricao inválida!
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group  col-12 col-lg-6">
                <label for="data_aquisicao">Data de Aquisição:</label>
                <input type="date" class="form-control" id="data_aquisicao" required>
                <div class="valid-feedback" id="valida-data_aquisicao-valid">
                </div>
                <div class="invalid-feedback" id="valida-data_aquisicao">
                    Informe uma data Menor que a data atual!
                </div>
            </div>
            <div class="form-group  col-12 col-lg-6">
                <label for="data_compra">Data de Perda:</label>
                <input type="date" class="form-control" id="data_perda" required>
                <div class="valid-feedback" id="valida-data_perda-valid">
                </div>
                <div class="invalid-feedback" id="valida-data_perda">
                    Informe uma data Menor que a data atual!
                </div>
            </div>
        </div>
        <button class="btn btn-dark float-left my-3 " onclick="javascript: Limpar();" type="button">Limpar</button>
        <button class="btn btn-dark float-right my-3 " onclick="javascript: Gravar();" type="button">Gravar</button>
    
</div>
<div class="modal" id="Erro" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="titulo"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="corpo">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger vermelho txt-branco" data-dismiss="modal">Okay</button>
            </div>
        </div>
    </div>
</div>

